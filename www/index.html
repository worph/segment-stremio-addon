<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Segment Stremio Addon</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #fff;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem;
        }
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }
        h1 {
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        .badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            background: #8b5cf6;
            color: #fff;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: bold;
        }
        .card {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .card h2 {
            color: #4dabf7;
            font-size: 1.1rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .card h3 {
            color: #22d3ee;
            font-size: 0.95rem;
            margin-top: 1.25rem;
            margin-bottom: 0.75rem;
        }
        .card p {
            color: #aaa;
            line-height: 1.6;
            margin-bottom: 0.75rem;
        }
        .card ul {
            color: #aaa;
            margin-left: 1.5rem;
            margin-bottom: 0.75rem;
        }
        .card li {
            margin-bottom: 0.5rem;
            line-height: 1.5;
        }
        .url-box {
            background: #111;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 1rem;
            font-family: monospace;
            font-size: 0.9rem;
            word-break: break-all;
            margin: 1rem 0;
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .url-text {
            flex: 1;
            color: #51cf66;
        }
        .copy-btn {
            background: #4dabf7;
            color: #000;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 500;
            white-space: nowrap;
            transition: background 0.2s;
        }
        .copy-btn:hover {
            background: #74c0fc;
        }
        .copy-btn.copied {
            background: #51cf66;
        }
        .step {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            align-items: flex-start;
        }
        .step-number {
            background: #4dabf7;
            color: #000;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.85rem;
            flex-shrink: 0;
        }
        .step-content {
            flex: 1;
        }
        .step-content p {
            margin-bottom: 0;
        }
        .note {
            background: rgba(77, 171, 247, 0.1);
            border-left: 3px solid #4dabf7;
            padding: 1rem;
            border-radius: 0 8px 8px 0;
            margin: 1rem 0;
        }
        .note p {
            margin: 0;
            color: #ccc;
        }
        .note strong {
            color: #4dabf7;
        }
        .warning {
            background: rgba(255, 212, 59, 0.1);
            border-left: 3px solid #ffd43b;
        }
        .warning strong {
            color: #ffd43b;
        }
        .install-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
            color: #fff;
            text-decoration: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 500;
            font-size: 1rem;
            margin-top: 1rem;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .install-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
        }
        .features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        .feature {
            background: rgba(0,0,0,0.2);
            padding: 1rem;
            border-radius: 8px;
        }
        .feature-icon {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }
        .feature-title {
            color: #fff;
            font-weight: 500;
            margin-bottom: 0.25rem;
        }
        .feature-desc {
            color: #888;
            font-size: 0.85rem;
        }
        code {
            background: rgba(0,0,0,0.3);
            padding: 0.15rem 0.4rem;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.85em;
        }
        a {
            color: #4dabf7;
        }
        /* Metrics Panel Styles */
        .metrics-toggle {
            background: #4dabf7;
            color: #000;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 500;
            transition: background 0.2s;
        }
        .metrics-toggle:hover {
            background: #74c0fc;
        }
        .metrics-toggle.active {
            background: #51cf66;
        }
        .metrics-panel {
            display: none;
            margin-top: 1rem;
        }
        .metrics-panel.active {
            display: block;
        }
        .metrics-section {
            margin-bottom: 1.25rem;
        }
        .metrics-section:last-child {
            margin-bottom: 0;
        }
        .metrics-section h3 {
            color: #22d3ee;
            margin-bottom: 0.75rem;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 0.5rem;
        }
        .metric-item {
            background: rgba(0, 0, 0, 0.3);
            padding: 0.6rem;
            border-radius: 8px;
            text-align: center;
        }
        .metric-value {
            font-size: 1.1rem;
            font-weight: 600;
            color: #fff;
        }
        .metric-value.good { color: #51cf66; }
        .metric-value.warning { color: #ffd43b; }
        .metric-value.bad { color: #ff6b6b; }
        .metric-label {
            font-size: 0.65rem;
            color: #888;
            margin-top: 0.2rem;
            text-transform: uppercase;
        }
        .adaptive-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        .adaptive-item {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            padding: 0.75rem;
            text-align: center;
        }
        .adaptive-label {
            font-size: 0.7rem;
            color: #888;
            text-transform: uppercase;
            margin-bottom: 0.3rem;
        }
        .adaptive-value {
            font-size: 1.2rem;
            font-weight: 700;
            color: #fff;
            text-transform: uppercase;
            margin-bottom: 0.5rem;
        }
        .adaptive-bar {
            height: 10px;
            border-radius: 5px;
            position: relative;
            margin-bottom: 0.3rem;
        }
        .preset-bar {
            background: linear-gradient(to right, #ff922b, #ffd43b 30%, #51cf66 60%, #4dabf7);
        }
        .crf-bar {
            background: linear-gradient(to right, #51cf66, #ffd43b 40%, #ff922b 70%, #ff6b6b);
        }
        .adaptive-bar-fill {
            position: absolute;
            top: -2px;
            height: 14px;
            width: 6px;
            background: #fff;
            border-radius: 3px;
            box-shadow: 0 0 6px rgba(0,0,0,0.5), 0 0 3px rgba(255,255,255,0.8);
            transition: left 0.3s ease;
            transform: translateX(-50%);
        }
        .adaptive-range {
            display: flex;
            justify-content: space-between;
            font-size: 0.6rem;
            color: #666;
        }
        .adaptive-range .range-good { color: #51cf66; }
        .adaptive-range .range-fast { color: #ff922b; }
        .adaptive-stats {
            display: flex;
            gap: 0.75rem;
            justify-content: center;
            margin-top: 0.5rem;
        }
        .adaptive-stats span {
            padding: 0.2rem 0.5rem;
            background: rgba(0,0,0,0.3);
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .stat-up { color: #51cf66; }
        .stat-down { color: #ff6b6b; }
        .ratio-gauge {
            background: rgba(0,0,0,0.3);
            border-radius: 12px;
            padding: 0.75rem;
        }
        .ratio-bar {
            position: relative;
            height: 24px;
            background: linear-gradient(to right,
                #51cf66 0%, #51cf66 60%,
                #51cf66 60%, #51cf66 80%,
                #ffd43b 80%, #ffd43b 90%,
                #ff6b6b 90%, #ff6b6b 100%
            );
            border-radius: 6px;
            margin-bottom: 0.4rem;
            overflow: visible;
        }
        .ratio-target {
            position: absolute;
            top: 0;
            left: 60%;
            width: 20%;
            height: 100%;
            background: rgba(255,255,255,0.15);
            border: 2px solid rgba(255,255,255,0.4);
            border-radius: 6px;
            box-sizing: border-box;
        }
        .ratio-needle {
            position: absolute;
            top: -6px;
            width: 4px;
            height: 36px;
            background: #fff;
            border-radius: 2px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.5);
            transform: translateX(-50%);
            transition: left 0.3s ease;
            left: 0%;
        }
        .ratio-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.65rem;
            color: #666;
            padding: 0 0.25rem;
        }
        .ratio-labels .target-label {
            color: #51cf66;
            font-weight: 600;
        }
        .ratio-value {
            text-align: center;
            font-size: 1.5rem;
            font-weight: 700;
            margin-top: 0.5rem;
        }
        .idle-message {
            text-align: center;
            color: #888;
            padding: 2rem;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>
                Segment Stremio Addon
            </h1>
            <button class="metrics-toggle" id="metricsToggle">Metrics</button>
        </header>

        <!-- Live Metrics Panel -->
        <div class="card" id="metricsCard" style="display: none;">
            <h2>&#128202; Live Transcoding Metrics</h2>
            <div class="metrics-panel active" id="metricsPanel">
                <div id="metricsContent">
                    <div class="idle-message" id="idleMessage">
                        <div style="margin-bottom: 0.5rem;">No active transcoding</div>
                        <div style="font-size: 0.9rem;">Media library: <strong id="totalFilesIdle">0</strong> files</div>
                        <div style="font-size: 0.85rem; margin-top: 0.5rem;">Start playing a video in Stremio to see live metrics.</div>
                    </div>
                </div>
                <div id="activeMetrics" style="display: none;">
                    <div class="metrics-section">
                        <h3>Now Playing</h3>
                        <div class="now-playing-file" id="nowPlayingFile" style="background: rgba(0,0,0,0.3); padding: 0.75rem; border-radius: 8px; word-break: break-all; color: #51cf66; font-family: monospace; font-size: 0.85rem;">-</div>
                    </div>
                    <div class="metrics-section">
                        <h3>Source Codecs</h3>
                        <div class="metrics-grid" style="grid-template-columns: 1fr 1fr;">
                            <div class="metric-item">
                                <div class="metric-value" id="metricVideoCodec">-</div>
                                <div class="metric-label">Video</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-value" id="metricAudioCodec">-</div>
                                <div class="metric-label">Audio</div>
                            </div>
                        </div>
                    </div>
                    <div class="metrics-section">
                        <h3>Adaptive Quality</h3>
                        <div class="adaptive-grid">
                            <div class="adaptive-item">
                                <div class="adaptive-label">Encoder Preset</div>
                                <div class="adaptive-value" id="metricPreset">fast</div>
                                <div class="adaptive-bar preset-bar">
                                    <div class="adaptive-bar-fill" id="presetBar" style="left: 50%;"></div>
                                </div>
                                <div class="adaptive-range">
                                    <span class="range-fast">ultrafast</span>
                                    <span class="range-good">medium</span>
                                </div>
                                <div class="adaptive-stats">
                                    <span class="stat-up" id="presetAdjustUp" title="Quality increases">&#9650; 0</span>
                                    <span class="stat-down" id="presetAdjustDown" title="Quality decreases">&#9660; 0</span>
                                </div>
                            </div>
                            <div class="adaptive-item">
                                <div class="adaptive-label">CRF Offset</div>
                                <div class="adaptive-value" id="metricCRF">+0</div>
                                <div class="adaptive-bar crf-bar">
                                    <div class="adaptive-bar-fill" id="crfBar" style="left: 0%;"></div>
                                </div>
                                <div class="adaptive-range">
                                    <span class="range-good">+0 best</span>
                                    <span class="range-fast">+7 fast</span>
                                </div>
                                <div class="adaptive-stats">
                                    <span class="stat-up" id="crfAdjustDown" title="Quality increases">&#9650; 0</span>
                                    <span class="stat-down" id="crfAdjustUp" title="Quality decreases">&#9660; 0</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="metrics-section">
                        <h3>Transcode Ratio</h3>
                        <div class="ratio-gauge">
                            <div class="ratio-bar">
                                <div class="ratio-target"></div>
                                <div class="ratio-needle" id="ratioNeedle"></div>
                            </div>
                            <div class="ratio-labels">
                                <span>0%</span>
                                <span>50%</span>
                                <span class="target-label">60-80%</span>
                                <span>100%</span>
                            </div>
                            <div class="ratio-value" id="ratioValue">-</div>
                        </div>
                    </div>
                    <div class="metrics-section">
                        <h3>Performance</h3>
                        <div class="metrics-grid">
                            <div class="metric-item">
                                <div class="metric-value" id="metricRatioAvg">-</div>
                                <div class="metric-label">Avg Ratio</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-value" id="metricRatioLast">-</div>
                                <div class="metric-label">Last Ratio</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-value" id="metricCacheHit">-</div>
                                <div class="metric-label">Cache Hit</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-value" id="metricSegments">-</div>
                                <div class="metric-label">Segments</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Introduction -->
        <div class="card">
            <h2>What is this addon?</h2>
            <p>
                This Stremio addon lets you browse and stream your local media library directly
                in <a href="https://www.stremio.com/" target="_blank">Stremio</a>,
                a popular media center application available on Windows, macOS, Linux, Android, and iOS.
            </p>

            <div class="features">
                <div class="feature">
                    <div class="feature-icon">&#128250;</div>
                    <div class="feature-title">Browse Library</div>
                    <div class="feature-desc">View all your media files in Stremio's catalog</div>
                </div>
                <div class="feature">
                    <div class="feature-icon">&#9889;</div>
                    <div class="feature-title">Live Transcoding</div>
                    <div class="feature-desc">Play any format with on-the-fly HLS conversion</div>
                </div>
                <div class="feature">
                    <div class="feature-icon">&#127909;</div>
                    <div class="feature-title">Quality Selection</div>
                    <div class="feature-desc">Choose from multiple resolution options</div>
                </div>
                <div class="feature">
                    <div class="feature-icon">&#127760;</div>
                    <div class="feature-title">Remote Access</div>
                    <div class="feature-desc">Stream from anywhere on your network</div>
                </div>
            </div>
        </div>

        <!-- Installation Steps -->
        <div class="card">
            <h2>&#9881; Installation Guide</h2>

            <h3>Step 1: Get Your Addon URL</h3>
            <p>Copy the addon manifest URL below. This URL should be accessible from where Stremio is running.</p>

            <div class="url-box">
                <span class="url-text" id="addonUrl">Loading...</span>
                <button class="copy-btn" onclick="copyUrl()">Copy</button>
            </div>


            <h3>Step 2: Install in Stremio</h3>

            <div class="step">
                <div class="step-number">1</div>
                <div class="step-content">
                    <p>Open Stremio and go to <strong>Settings</strong> (gear icon) > <strong>Addons</strong></p>
                </div>
            </div>

            <div class="step">
                <div class="step-number">2</div>
                <div class="step-content">
                    <p>Scroll down and click <strong>"Install addon from URL"</strong></p>
                </div>
            </div>

            <div class="step">
                <div class="step-number">3</div>
                <div class="step-content">
                    <p>Paste the addon URL and click <strong>"Add"</strong></p>
                </div>
            </div>

            <div class="step">
                <div class="step-number">4</div>
                <div class="step-content">
                    <p>The addon will appear in your addon list. Click <strong>"Install"</strong> to confirm.</p>
                </div>
            </div>

            <h3>Step 3: Browse Your Library</h3>
            <p>
                After installation, you'll find "SSA" in your Stremio catalog.
                Click on it to browse your media files. Select any video to see available streams.
            </p>

            <div class="note">
                <p>
                    <strong>Tip:</strong> Each video offers multiple stream options:
                </p>
                <ul style="margin-top: 0.5rem;">
                    <li><strong>Direct Play</strong> - Play original file (if compatible)</li>
                    <li><strong>HLS Original</strong> - Transcoded at source resolution</li>
                    <li><strong>HLS Auto (ABR)</strong> - Adaptive quality based on bandwidth</li>
                </ul>
            </div>
        </div>

        <!-- Alternative: One-Click Install -->
        <div class="card">
            <h2>&#128640; Quick Install</h2>
            <p>
                If you have Stremio installed and running, you can use this button to install
                the addon directly:
            </p>
            <a href="#" class="install-btn" id="installBtn" onclick="installAddon(event)">
                <span>&#10003;</span> Install in Stremio
            </a>
            <p style="margin-top: 1rem; font-size: 0.85rem;">
                This will open Stremio and prompt you to install the addon.
            </p>
        </div>

        <!-- Troubleshooting -->
        <div class="card">
            <h2>&#128295; Troubleshooting</h2>

            <h3>Addon not loading?</h3>
            <ul>
                <li>Make sure this addon is running</li>
                <li>Check that the URL is accessible from your device (try opening it in a browser)</li>
                <li>If using Docker, ensure ports are properly mapped</li>
            </ul>

            <h3>Videos not playing?</h3>
            <ul>
                <li>Verify the addon is running and accessible</li>
                <li>Check that your media files are in the configured media directory</li>
                <li>Try the web player first to verify transcoding works</li>
            </ul>

            <h3>Testing the Addon</h3>
            <p>You can verify the addon is working by opening these URLs in your browser:</p>
            <ul>
                <li><a href="/manifest.json" target="_blank">/manifest.json</a> - Should show addon info</li>
                <li><a href="/catalog/movie/segmentplayer_all.json" target="_blank">/catalog/movie/segmentplayer_all.json</a> - Should list your videos</li>
            </ul>
        </div>

    </div>

    <script>
        // Determine the addon URL based on current page URL
        function getAddonUrl() {
            const protocol = window.location.protocol;
            const host = window.location.host;
            return `${protocol}//${host}/manifest.json`;
        }

        // Update URL display on page load
        document.getElementById('addonUrl').textContent = getAddonUrl();

        // Update install button href
        function getInstallUrl() {
            const manifestUrl = getAddonUrl();
            // Stremio protocol handler
            return `stremio://${manifestUrl.replace(/^https?:\/\//, '')}`;
        }
        document.getElementById('installBtn').href = getInstallUrl();

        // Copy URL to clipboard
        function copyUrl() {
            const url = getAddonUrl();
            navigator.clipboard.writeText(url).then(() => {
                const btn = document.querySelector('.copy-btn');
                btn.textContent = 'Copied!';
                btn.classList.add('copied');
                setTimeout(() => {
                    btn.textContent = 'Copy';
                    btn.classList.remove('copied');
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy:', err);
                prompt('Copy this URL:', url);
            });
        }

        // Install addon via Stremio protocol
        function installAddon(event) {
            const installUrl = getInstallUrl();
            window.location.href = installUrl;
        }

        // Metrics functionality
        const PRESETS = ['ultrafast', 'superfast', 'veryfast', 'faster', 'fast', 'medium'];
        let metricsInterval = null;

        function formatRatio(ratio) {
            return ratio ? ratio.toFixed(1) + "%" : "-";
        }

        function getRatioClass(ratio) {
            if (!ratio) return "";
            if (ratio >= 60 && ratio <= 80) return "good";
            if (ratio < 60) return "good";
            if (ratio < 90) return "warning";
            return "bad";
        }

        async function fetchMetrics() {
            try {
                const response = await fetch("/transcode/metrics");
                if (!response.ok) return;

                const data = await response.json();

                // Update total files count (always, even when idle)
                if (data.total_files !== undefined) {
                    document.getElementById("totalFilesIdle").textContent = data.total_files;
                }

                // Check if there's any transcoding activity
                const hasActivity = data.total_segments > 0;
                document.getElementById("idleMessage").style.display = hasActivity ? "none" : "block";
                document.getElementById("activeMetrics").style.display = hasActivity ? "block" : "none";

                if (!hasActivity) return;

                // Update adaptive quality display
                if (data.adaptive_quality) {
                    const aq = data.adaptive_quality;

                    // Preset
                    document.getElementById("metricPreset").textContent = aq.preset || "fast";
                    const presetIndex = PRESETS.indexOf(aq.preset);
                    const presetPosition = presetIndex >= 0 ? (presetIndex / (PRESETS.length - 1)) * 100 : 50;
                    document.getElementById("presetBar").style.left = presetPosition + "%";
                    document.getElementById("presetAdjustUp").innerHTML = "&#9650; " + (aq.preset_adjustments?.up || 0);
                    document.getElementById("presetAdjustDown").innerHTML = "&#9660; " + (aq.preset_adjustments?.down || 0);

                    // CRF
                    document.getElementById("metricCRF").textContent = "+" + (aq.crf_offset || 0);
                    const crfPosition = ((aq.crf_offset || 0) / 7) * 100;
                    document.getElementById("crfBar").style.left = crfPosition + "%";
                    document.getElementById("crfAdjustDown").innerHTML = "&#9650; " + (aq.crf_adjustments?.down || 0);
                    document.getElementById("crfAdjustUp").innerHTML = "&#9660; " + (aq.crf_adjustments?.up || 0);
                }

                // Update ratio gauge
                const avgRatio = data.transcode_ratio_avg || 0;
                const needlePos = Math.min(100, Math.max(0, avgRatio));
                document.getElementById("ratioNeedle").style.left = needlePos + "%";
                document.getElementById("ratioValue").textContent = formatRatio(avgRatio);
                document.getElementById("ratioValue").className = "ratio-value " + getRatioClass(avgRatio);

                // Update performance metrics
                document.getElementById("metricRatioAvg").textContent = formatRatio(data.transcode_ratio_avg);
                document.getElementById("metricRatioAvg").className = "metric-value " + getRatioClass(data.transcode_ratio_avg);

                document.getElementById("metricRatioLast").textContent = formatRatio(data.transcode_ratio_last);
                document.getElementById("metricRatioLast").className = "metric-value " + getRatioClass(data.transcode_ratio_last);

                document.getElementById("metricCacheHit").textContent = data.cache_hit_rate ? data.cache_hit_rate.toFixed(1) + "%" : "-";
                document.getElementById("metricCacheHit").className = "metric-value " + (data.cache_hit_rate > 50 ? "good" : "");

                document.getElementById("metricSegments").textContent = data.total_segments || 0;

                // Update codec info
                document.getElementById("metricVideoCodec").textContent = data.video_codec ? data.video_codec.toUpperCase() : "-";
                document.getElementById("metricAudioCodec").textContent = data.audio_codec ? data.audio_codec.toUpperCase() : "-";

                // Update current file
                document.getElementById("nowPlayingFile").textContent = data.current_file || "-";

            } catch (err) {
                console.error("Failed to fetch metrics:", err);
            }
        }

        // Metrics toggle
        document.getElementById("metricsToggle").addEventListener("click", function() {
            this.classList.toggle("active");
            const metricsCard = document.getElementById("metricsCard");
            const isActive = this.classList.contains("active");

            metricsCard.style.display = isActive ? "block" : "none";

            if (isActive) {
                fetchMetrics();
                metricsInterval = setInterval(fetchMetrics, 2000);
            } else {
                if (metricsInterval) {
                    clearInterval(metricsInterval);
                    metricsInterval = null;
                }
            }
        });
    </script>
</body>
</html>
